name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  XCODE_VERSION: '16.4'
  IOS_DEPLOYMENT_TARGET: '17.0'

jobs:
  build-and-test:
    name: Build and Test iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Cache derived data
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
          
    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Validate project configuration
      run: ./build.sh validate
      
    - name: Clean build directories
      run: ./build.sh clean
      
    - name: Build main app and widget extension
      run: ./build.sh build
      
    - name: Test widget extension build
      run: ./build.sh widget-test
      
    - name: Run unit tests
      run: ./build.sh test
      continue-on-error: true  # Allow tests to fail without failing the workflow
      
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ios-build-artifacts
        path: |
          build/
          !build/**/*.o
          !build/**/*.d
        retention-days: 30
        
    - name: Generate build report
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Project:** Vecka iOS App with Widget Extension" >> $GITHUB_STEP_SUMMARY
        echo "- **Targets:** Main App (Vecka), Widget Extension (VeckaWidget), Shared Framework (VeckaShared)" >> $GITHUB_STEP_SUMMARY
        echo "- **Bundle IDs:** Johansson.Vecka, Johansson.Vecka.VeckaWidget, Johansson.VeckaShared" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Target:** iOS ${{ env.IOS_DEPLOYMENT_TARGET }}+" >> $GITHUB_STEP_SUMMARY
        echo "- **Xcode Version:** ${{ env.XCODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
  code-quality:
    name: Code Quality Checks
    runs-on: macos-latest
    needs: build-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Install SwiftLint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        
    - name: Run SwiftLint
      run: |
        swiftlint lint --reporter github-actions-logging
      continue-on-error: true
      
    - name: Check for TODO/FIXME comments
      run: |
        echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
        TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.swift" . | wc -l || echo "0")
        echo "- **TODO/FIXME comments found:** $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "### TODO/FIXME items:" >> $GITHUB_STEP_SUMMARY
          grep -r "TODO\|FIXME" --include="*.swift" . | head -10 >> $GITHUB_STEP_SUMMARY || true
        fi
        
  widget-validation:
    name: Widget-Specific Validation
    runs-on: macos-latest
    needs: build-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Validate widget Info.plist
      run: |
        if [ -f "VeckaWidget/Info.plist" ]; then
          plutil -lint VeckaWidget/Info.plist
          echo "✅ Widget Info.plist is valid"
        else
          echo "❌ Widget Info.plist not found"
          exit 1
        fi
        
    - name: Check widget bundle identifier
      run: |
        BUNDLE_ID=$(plutil -extract CFBundleIdentifier raw VeckaWidget/Info.plist 2>/dev/null || echo "")
        if [ "$BUNDLE_ID" = "Johansson.Vecka.VeckaWidget" ]; then
          echo "✅ Widget bundle identifier is correct: $BUNDLE_ID"
        else
          echo "❌ Widget bundle identifier mismatch. Expected: Johansson.Vecka.VeckaWidget, Found: $BUNDLE_ID"
          exit 1
        fi
        
    - name: Validate widget extension point
      run: |
        EXTENSION_POINT=$(plutil -extract NSExtension.NSExtensionPointIdentifier raw VeckaWidget/Info.plist 2>/dev/null || echo "")
        if [ "$EXTENSION_POINT" = "com.apple.widgetkit-extension" ]; then
          echo "✅ Widget extension point is correct"
        else
          echo "❌ Widget extension point incorrect. Expected: com.apple.widgetkit-extension, Found: $EXTENSION_POINT"
          exit 1
        fi
        
    - name: Check shared framework integration
      run: |
        if grep -q "import VeckaShared" VeckaWidget/VeckaWidget.swift; then
          echo "✅ Widget properly imports VeckaShared framework"
        else
          echo "❌ Widget does not import VeckaShared framework"
          exit 1
        fi
        
    - name: Widget validation summary
      if: always()
      run: |
        echo "## Widget Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Widget Target:** VeckaWidget" >> $GITHUB_STEP_SUMMARY
        echo "- **Bundle ID:** Johansson.Vecka.VeckaWidget" >> $GITHUB_STEP_SUMMARY
        echo "- **Extension Point:** com.apple.widgetkit-extension" >> $GITHUB_STEP_SUMMARY
        echo "- **Shared Framework:** VeckaShared integration verified" >> $GITHUB_STEP_SUMMARY
        echo "- **Widget Sizes:** Small, Medium, Large supported" >> $GITHUB_STEP_SUMMARY