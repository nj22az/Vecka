<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Image Manager - Information Design</title>
    <style>
        :root {
            --black: #000000;
            --white: #FFFFFF;
            --yellow: #FFE566;
            --cyan: #A5F3FC;
            --pink: #FECDD3;
            --green: #BBF7D0;
            --red: #FECACA;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Rounded", "Helvetica Neue", sans-serif;
            background: var(--white);
            color: var(--black);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .header {
            background: var(--black);
            color: var(--white);
            padding: 20px;
            margin: -20px -20px 20px -20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }

        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

        .header button {
            background: var(--white);
            border: 2px solid var(--white);
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
        }

        .header button:hover { background: var(--yellow); }

        .header button.secondary {
            background: transparent;
            color: var(--white);
            border-color: var(--white);
        }

        .header button.secondary:hover {
            background: var(--white);
            color: var(--black);
        }

        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }

        .stat-box {
            background: var(--white);
            border: 2px solid var(--black);
            border-radius: 12px;
            padding: 16px 24px;
            text-align: center;
        }

        .stat-number { font-size: 32px; font-weight: 800; }
        .stat-label { font-size: 12px; text-transform: uppercase; font-weight: 600; color: #666; }

        .instructions {
            background: var(--cyan);
            border: 2px solid var(--black);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .instructions h3 { margin: 0 0 8px 0; }
        .instructions ol { margin: 0; padding-left: 20px; }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .image-card {
            border: 2px solid var(--black);
            border-radius: 12px;
            overflow: hidden;
            background: var(--white);
        }

        .image-card.has-image .card-header { background: var(--green); }

        .card-header {
            background: #f5f5f5;
            padding: 12px 16px;
            border-bottom: 2px solid var(--black);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-id { font-weight: 800; font-size: 14px; }
        .card-chapter { font-size: 12px; color: #666; margin-left: 8px; }

        .card-filename {
            font-family: "SF Mono", monospace;
            font-size: 12px;
            background: var(--black);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .card-body { padding: 16px; }

        .card-type {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            color: #666;
            margin-bottom: 8px;
        }

        .card-prompt {
            font-size: 13px;
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .copy-btn {
            background: var(--white);
            border: 1.5px solid var(--black);
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .copy-btn:hover { background: var(--yellow); }
        .copy-btn.copied { background: var(--green); }

        .upload-zone {
            border: 2px dashed var(--black);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone:hover { background: var(--yellow); border-style: solid; }
        .upload-zone.dragover { background: var(--yellow); border-style: solid; }
        .upload-zone input { display: none; }
        .upload-zone .upload-icon { font-size: 32px; margin-bottom: 8px; }
        .upload-zone .upload-text { font-size: 13px; font-weight: 600; }
        .upload-zone .upload-hint { font-size: 11px; color: #666; margin-top: 4px; }

        .preview-container { position: relative; width: 100%; }

        .preview-img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--red);
            border: 2px solid var(--black);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .remove-btn:hover { background: #ff6b6b; }

        .folder-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--white);
            border: 1px solid var(--black);
            border-radius: 6px;
        }

        .folder-status.connected { background: var(--green); }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .folder-status.connected .status-dot { background: #22c55e; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

        .filter-btn {
            background: var(--white);
            border: 2px solid var(--black);
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
        }

        .filter-btn:hover, .filter-btn.active { background: var(--yellow); }

        @media (max-width: 600px) { .image-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Book Image Manager</h1>
        <div class="header-buttons">
            <button id="select-folder-btn">Select Images Folder</button>
            <button class="secondary" id="preview-btn">Preview Book</button>
            <button class="secondary" id="export-btn">Export Updated CSV</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-number" id="total-count">36</div>
            <div class="stat-label">Total Images</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="uploaded-count">0</div>
            <div class="stat-label">Uploaded</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="remaining-count">36</div>
            <div class="stat-label">Remaining</div>
        </div>
    </div>

    <div class="folder-status" id="folder-status">
        <span class="status-dot"></span>
        <span id="folder-text">No folder selected - images will download individually</span>
    </div>

    <div class="instructions">
        <h3>How to Use</h3>
        <ol>
            <li><strong>Click "Select Images Folder"</strong> to choose your book/images folder (enables auto-save)</li>
            <li><strong>Copy the prompt</strong> for each image and paste into ChatGPT, Gemini, or Midjourney</li>
            <li><strong>Upload or drag the generated image</strong> into the upload zone</li>
            <li>The image will be automatically saved with the correct filename</li>
            <li><strong>Preview the book</strong> to see your images in context</li>
        </ol>
    </div>

    <div class="filter-bar" id="filter-bar"></div>

    <div class="image-grid" id="image-grid"></div>

    <script>
        const imageData = [
            { id: 1, chapter: "Cover", type: "Cover Art", filename: "cover.png", prompt: "Book cover for 'Information Design'. Clean white background with thick black border (3pt weight) around entire cover. Title 'INFORMATION DESIGN' in large bold black sans-serif text centered upper third. Japanese characters 'Joho Dezain' directly below the English title as subtitle. Author credit 'As Interpreted by Nils Johansson' at bottom in smaller text. Center section features a bento-box grid layout with geometric shapes: colored circles (cyan, pink, yellow, orange, green, purple) each with thin black borders, arranged in compartments divided by black lines. Minimalist, technical, professional. No gradients, no shadows, flat design only. 6x9 inch book cover proportions." },
            { id: 2, chapter: "Chapter 1", type: "Concept Diagram", filename: "bento-diagram.png", prompt: "Bento box lunch diagram showing compartmentalized sections. Black lines dividing white container into 6 sections. Each section labeled: rice, protein, vegetables, preserved items, fruit, sauce. Clean top-down view. Thick black borders. Minimalist Japanese style." },
            { id: 3, chapter: "Chapter 1", type: "Comparison", filename: "comparison.png", prompt: "Side by side comparison: LEFT labeled 'Cluttered Interface' showing overlapping elements, gradients, shadows, blur effects. RIGHT labeled 'Joho Dezain Interface' showing clean grid, black borders, flat colors, organized compartments. Technical diagram style." },
            { id: 4, chapter: "Chapter 2", type: "Historical", filename: "train-signage.png", prompt: "Japanese train station sign diagram. White background, black border, destination names in bold Japanese text. Colored line indicators (colored circles with black borders). Platform numbers. Clean wayfinding design. Technical illustration." },
            { id: 5, chapter: "Chapter 2", type: "Timeline", filename: "timeline.png", prompt: "Horizontal timeline from 1960 to 2024. Key milestones marked: 1964 Olympics pictograms, 1980s JIS standards, 1990s Muji founding, 2007 iPhone, 2020s iOS design. Black line with circular markers. Minimalist style." },
            { id: 6, chapter: "Chapter 3", type: "Principles Grid", filename: "principles-grid.png", prompt: "3x3 grid showing 9 icons representing core principles: border (square), color (palette), typography (Aa), spacing (grid), corners (squircle), no blur (crossed circle), no gradients (flat rectangle), semantic meaning (colored dots), consistency (equals sign). Black icons on white, thick borders." },
            { id: 7, chapter: "Chapter 4", type: "Color Palette", filename: "color-palette.png", prompt: "Horizontal color swatches with labels. Each swatch is a rectangle with black border: Yellow #FFE566 'Today', Cyan #A5F3FC 'Events', Pink #FECDD3 'Holidays', Orange #FED7AA 'Trips', Green #BBF7D0 'Money', Purple #E9D5FF 'People', Red #E53935 'Warning'. Technical specification style." },
            { id: 8, chapter: "Chapter 4", type: "Color Usage", filename: "color-usage.png", prompt: "Calendar interface mockup showing colored indicator dots on dates. Small circles (cyan, pink, orange) next to date numbers. Yellow highlight on 'today' cell. All dots have thin black borders. Clean grid layout." },
            { id: 9, chapter: "Chapter 5", type: "Border Weights", filename: "border-weights.png", prompt: "Five horizontal lines showing border weights: 1pt (cells), 1.5pt (rows), 2pt (buttons), 2.5pt (selected), 3pt (containers). Each labeled with use case. Technical specification diagram." },
            { id: 10, chapter: "Chapter 5", type: "Border Diagram", filename: "border-nesting.png", prompt: "Nested rectangles showing container hierarchy. Outer box 3pt border, middle section 1.5pt border, inner cards 1.5pt border, smallest elements 1pt border. Labels pointing to each level. Cross-section view." },
            { id: 11, chapter: "Chapter 6", type: "Type Scale", filename: "type-scale.png", prompt: "Vertical list showing typography scale. Each line in its actual size: 48pt 'Display Large', 32pt 'Display Medium', 18pt 'Headline', 16pt 'Body', 14pt 'Body Small', 12pt 'LABEL', 10pt 'Label Small'. Rounded sans-serif font. Size and weight noted." },
            { id: 12, chapter: "Chapter 6", type: "Font Comparison", filename: "font-comparison.png", prompt: "Side by side: LEFT 'Sharp Typography' with pointed serifs and thin weights. RIGHT 'Rounded Typography' with soft terminals and medium weight. Same phrase 'Week 42' in both. Circle highlighting the difference in letter terminals." },
            { id: 13, chapter: "Chapter 7", type: "Spacing Grid", filename: "spacing-grid.png", prompt: "Grid diagram showing 4pt base unit. Squares labeled: 4pt (xs), 8pt (sm), 12pt (md), 16pt (lg), 20pt (xl), 24pt (xxl), 32pt (xxxl). Each square proportionally sized. Technical blueprint style with measurements." },
            { id: 14, chapter: "Chapter 7", type: "Touch Targets", filename: "touch-targets.png", prompt: "Diagram showing small icon (20pt) inside larger touch area (44pt square with dashed border). Label '44pt minimum touch target'. Finger silhouette for scale. Technical HIG-style diagram." },
            { id: 15, chapter: "Chapter 8", type: "Maru Batsu", filename: "maru-batsu.png", prompt: "Japanese symbol chart. Row of symbols with meanings: ◎ 'Excellent', ○ 'Good/Yes', △ 'Caution', □ 'Info', × 'No/Wrong', ー 'N/A'. Clean grid layout. Each symbol in a bordered cell with Japanese and English labels." },
            { id: 16, chapter: "Chapter 8", type: "Filled vs Outlined", filename: "filled-outlined.png", prompt: "Comparison grid: ● vs ○ (filled/outlined circle), ▲ vs △ (triangle), ■ vs □ (square), ◆ vs ◇ (diamond). Labels showing 'Strong' for filled, 'Standard' for outlined. Two-column layout." },
            { id: 17, chapter: "Chapter 9", type: "Container Types", filename: "container-types.png", prompt: "Four container diagrams stacked vertically: JohoContainer (3pt border, 16pt radius), JohoCard (1.5pt border, 12pt radius), JohoSectionBox (with header pill), JohoFormSection (black header bar). Each labeled with specs." },
            { id: 18, chapter: "Chapter 9", type: "Nesting Diagram", filename: "nesting-diagram.png", prompt: "Three levels of nested containers. Outer container (3pt), section inside (1.5pt), cards inside section (1.5pt), elements inside cards (1pt). Arrows pointing to each border weight. Exploded view style." },
            { id: 19, chapter: "Chapter 10", type: "Button States", filename: "button-states.png", prompt: "Three button states side by side: Normal (white bg, 2pt border), Pressed (light gray bg), Disabled (50% opacity). Each labeled. Same 'Action' text in all three. Technical UI specification." },
            { id: 20, chapter: "Chapter 10", type: "Toggle Design", filename: "toggle-design.png", prompt: "Toggle switch diagram showing OFF and ON states. OFF: white track, circle on left. ON: cyan track, circle on right. Both with 2pt black border around track. Animation arrow between states." },
            { id: 21, chapter: "Chapter 10", type: "Swipe Actions", filename: "swipe-actions.png", prompt: "List row with swipe actions revealed. Left side shows cyan 'Edit' action. Right side shows red 'Delete' action. Center shows content. Arrows indicating swipe direction. Technical UI diagram." },
            { id: 22, chapter: "Chapter 11", type: "Bento Header", filename: "bento-header.png", prompt: "Header component diagram with three zones labeled: Zone A (fixed width, hero number '42'), Zone B (flexible, context info), Zone C (fixed width, navigation arrows). Measurements shown. 3pt outer border." },
            { id: 23, chapter: "Chapter 11", type: "Navigation Comparison", filename: "navigation-comparison.png", prompt: "Two layouts: LEFT 'iPad Sidebar' showing vertical navigation with 200pt sidebar and content area. RIGHT 'iPhone Tab Bar' showing content area with bottom tab bar. Both with proper borders and labels." },
            { id: 24, chapter: "Chapter 12", type: "Calendar Grid", filename: "calendar-grid.png", prompt: "7-column calendar grid. Header row (M T W T F S S) on black background with white text. Day cells below with numbers and colored indicator dots. 'Today' cell highlighted yellow. Sunday column in red text. All cells bordered." },
            { id: 25, chapter: "Chapter 12", type: "Week Row", filename: "week-row.png", prompt: "Horizontal week row diagram. Week number badge on left (WK 42), 7 day cells in middle with indicator dots, date range on right (Oct 14-20). Labels pointing to each zone. 1.5pt border around entire row." },
            { id: 26, chapter: "Chapter 13", type: "Architecture", filename: "architecture.png", prompt: "Flow diagram showing app architecture. Boxes connected by arrows: 'View Layer' → 'Manager Layer' → 'Model Layer' → 'Engine Layer'. Each box with 2pt border. Labels for each layer's responsibility." },
            { id: 27, chapter: "Chapter 14", type: "Day Cell States", filename: "day-cell-states.png", prompt: "Four day cells showing states: Normal (white bg, black text), Today (yellow bg), Sunday (red text), Selected (yellow tint, 2.5pt border). Each labeled. Grid layout." },
            { id: 28, chapter: "Chapter 14", type: "Indicator Legend", filename: "indicator-legend.png", prompt: "Legend showing all indicator dot colors with labels: Cyan dot 'Events', Pink dot 'Holidays', Orange dot 'Trips', Green dot 'Expenses', Purple dot 'Contacts', Yellow dot 'Notes'. Each dot has black border. Vertical list." },
            { id: 29, chapter: "Chapter 15", type: "Star Page", filename: "star-page.png", prompt: "Complete Star Page mockup. Star icon at top, bento header below, 'Today' section with cyan header pill and event cards, 'Upcoming' section with pink header pill and holiday cards. Full interface demonstration." },
            { id: 30, chapter: "Chapter 16", type: "Before After Settings", filename: "before-after-settings.png", prompt: "Side by side: LEFT 'Before' showing iOS default toggle rows with gray separators, no borders. RIGHT 'After' showing bordered cards with custom toggles. Labels highlighting differences." },
            { id: 31, chapter: "Chapter 16", type: "Before After Card", filename: "before-after-card.png", prompt: "Side by side: LEFT 'Before' showing card with shadow, emoji, rounded corners. RIGHT 'After' showing card with border, SF Symbol, squircle corners. Red X on problems, green check on solutions." },
            { id: 32, chapter: "Chapter 17", type: "Code Components", filename: "code-components.png", prompt: "Grid of 6 component previews: JohoButton, JohoCard, JohoToggle, JohoTextField, JohoSectionBox, JohoIndicator. Each in a small bordered box with component name below. Technical component library style." },
            { id: 33, chapter: "Chapter 18", type: "Checklist", filename: "checklist.png", prompt: "Visual checklist with checkboxes: Borders on all containers, Semantic colors only, Continuous corners, Rounded typography, 4pt spacing grid, 44pt touch targets, No shadows/blur. Black and white, technical style." },
            { id: 34, chapter: "Chapter 18", type: "Decision Tree", filename: "decision-tree.png", prompt: "Flowchart for border weight decisions. Diamond decision nodes: 'Interactive?' then 'Container?' then 'Card?' then 'Cell?'. Rectangular outcome nodes with border weights: 2pt, 3pt, 1.5pt, 1pt. Black lines connecting nodes." },
            { id: 35, chapter: "Back Cover", type: "Full Back Cover", filename: "back-cover.png", prompt: "Back cover for 'Information Design' book. White background with thick black border. TOP: Book description text area (placeholder lines). MIDDLE: Three key bullet points with black circular bullets: 'Complete design system with SwiftUI code', 'Real-world case study: WeekGrid app', 'Production-ready components'. BOTTOM LEFT: Small author photo placeholder (square with black border). BOTTOM RIGHT: QR code placeholder linking to weekgrid.app. Very bottom: ISBN barcode placeholder. Clean, minimal layout matching front cover style." },
            { id: 36, chapter: "Spine", type: "Book Spine", filename: "spine.png", prompt: "Vertical book spine for 'Information Design'. White background, black borders top and bottom. Text reading vertically (bottom to top): 'INFORMATION DESIGN' in bold, small separator dot, 'Nils Johansson' in lighter weight. Small colored dots (cyan, pink, yellow) as accent near top. Spine width approximately 0.5 inches for ~180 page book." }
        ];

        let uploadedImages = {};
        let folderHandle = null;

        function createElement(tag, props, children) {
            const el = document.createElement(tag);
            if (props) {
                Object.entries(props).forEach(([key, value]) => {
                    if (key === 'className') el.className = value;
                    else if (key === 'textContent') el.textContent = value;
                    else if (key.startsWith('on')) el[key] = value;
                    else if (key === 'style' && typeof value === 'object') Object.assign(el.style, value);
                    else el.setAttribute(key, value);
                });
            }
            if (children) {
                if (Array.isArray(children)) children.forEach(child => child && el.appendChild(child));
                else if (typeof children === 'string') el.textContent = children;
                else el.appendChild(children);
            }
            return el;
        }

        function init() {
            loadSavedState();
            setupEventListeners();
            renderFilterBar();
            renderCards();
            updateStats();
        }

        function loadSavedState() {
            const saved = localStorage.getItem('bookImageManager');
            if (saved) uploadedImages = JSON.parse(saved);
        }

        function saveState() {
            localStorage.setItem('bookImageManager', JSON.stringify(uploadedImages));
        }

        function setupEventListeners() {
            document.getElementById('select-folder-btn').onclick = selectImagesFolder;
            document.getElementById('preview-btn').onclick = () => window.open('index.html', '_blank');
            document.getElementById('export-btn').onclick = exportCSV;
        }

        function renderFilterBar() {
            const bar = document.getElementById('filter-bar');
            const filters = [
                { label: 'All', value: 'all' },
                { label: 'Pending', value: 'pending' },
                { label: 'Done', value: 'done' },
                { label: 'Cover', value: 'cover' },
                { label: 'Diagrams', value: 'diagram' }
            ];
            filters.forEach((f, i) => {
                const btn = createElement('button', {
                    className: 'filter-btn' + (i === 0 ? ' active' : ''),
                    textContent: f.label,
                    onclick: (e) => filterCards(f.value, e.target)
                });
                bar.appendChild(btn);
            });
        }

        function renderCards() {
            const grid = document.getElementById('image-grid');
            while (grid.firstChild) grid.removeChild(grid.firstChild);

            imageData.forEach(img => {
                const hasImage = uploadedImages[img.id];
                const card = createCard(img, hasImage);
                grid.appendChild(card);
            });
        }

        function createCard(img, hasImage) {
            const card = createElement('div', {
                className: 'image-card' + (hasImage ? ' has-image' : ''),
                'data-id': img.id,
                'data-chapter': img.chapter.toLowerCase(),
                'data-type': img.type.toLowerCase()
            });

            // Header
            const header = createElement('div', { className: 'card-header' });
            const headerLeft = createElement('div');
            headerLeft.appendChild(createElement('span', { className: 'card-id', textContent: '#' + img.id }));
            headerLeft.appendChild(createElement('span', { className: 'card-chapter', textContent: img.chapter }));
            header.appendChild(headerLeft);
            header.appendChild(createElement('span', { className: 'card-filename', textContent: img.filename }));
            card.appendChild(header);

            // Body
            const body = createElement('div', { className: 'card-body' });
            body.appendChild(createElement('div', { className: 'card-type', textContent: img.type }));
            body.appendChild(createElement('div', { className: 'card-prompt', textContent: img.prompt }));

            // Copy button
            const copyBtn = createElement('button', {
                className: 'copy-btn',
                textContent: 'Copy Prompt',
                onclick: () => copyPrompt(img.id, copyBtn)
            });
            body.appendChild(copyBtn);

            // Upload zone
            const uploadZone = createElement('div', {
                className: 'upload-zone',
                id: 'upload-' + img.id,
                ondragover: handleDragOver,
                ondragleave: handleDragLeave,
                ondrop: (e) => handleDrop(e, img.id),
                onclick: () => document.getElementById('file-' + img.id).click()
            });

            if (hasImage) {
                const previewContainer = createElement('div', { className: 'preview-container' });
                const previewImg = createElement('img', {
                    className: 'preview-img',
                    src: uploadedImages[img.id],
                    alt: 'Preview'
                });
                const removeBtn = createElement('button', {
                    className: 'remove-btn',
                    textContent: '\u00D7',
                    onclick: (e) => { e.stopPropagation(); removeImage(img.id); }
                });
                previewContainer.appendChild(previewImg);
                previewContainer.appendChild(removeBtn);
                uploadZone.appendChild(previewContainer);
            } else {
                uploadZone.appendChild(createElement('div', { className: 'upload-icon', textContent: '\uD83D\uDCC1' }));
                uploadZone.appendChild(createElement('div', { className: 'upload-text', textContent: 'Drop image or click to upload' }));
                uploadZone.appendChild(createElement('div', { className: 'upload-hint', textContent: 'Will be saved as ' + img.filename }));
            }

            const fileInput = createElement('input', {
                type: 'file',
                id: 'file-' + img.id,
                accept: 'image/*',
                onchange: (e) => handleFileSelect(e, img.id)
            });
            uploadZone.appendChild(fileInput);
            body.appendChild(uploadZone);
            card.appendChild(body);

            return card;
        }

        function updateStats() {
            const uploaded = Object.keys(uploadedImages).length;
            document.getElementById('uploaded-count').textContent = uploaded;
            document.getElementById('remaining-count').textContent = imageData.length - uploaded;
        }

        function copyPrompt(id, btn) {
            const img = imageData.find(i => i.id === id);
            navigator.clipboard.writeText(img.prompt).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Prompt';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, id) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processImage(file, id);
        }

        function handleFileSelect(e, id) {
            const file = e.target.files[0];
            if (file) processImage(file, id);
        }

        async function processImage(file, id) {
            const img = imageData.find(i => i.id === id);
            const reader = new FileReader();
            reader.onload = async (e) => {
                uploadedImages[id] = e.target.result;
                saveState();
                renderCards();
                updateStats();

                if (folderHandle) {
                    await saveToFolder(file, img.filename);
                } else {
                    downloadFile(e.target.result, img.filename);
                }
            };
            reader.readAsDataURL(file);
        }

        function downloadFile(dataUrl, filename) {
            const a = createElement('a', { href: dataUrl, download: filename });
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function selectImagesFolder() {
            try {
                folderHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                document.getElementById('folder-status').classList.add('connected');
                document.getElementById('folder-text').textContent = 'Connected: ' + folderHandle.name + ' - images will auto-save';
            } catch (err) {
                console.log('Folder selection cancelled');
            }
        }

        async function saveToFolder(file, filename) {
            if (!folderHandle) return;
            try {
                const fileHandle = await folderHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(file);
                await writable.close();
            } catch (err) {
                console.error('Error saving to folder:', err);
                const reader = new FileReader();
                reader.onload = (e) => downloadFile(e.target.result, filename);
                reader.readAsDataURL(file);
            }
        }

        function removeImage(id) {
            delete uploadedImages[id];
            saveState();
            renderCards();
            updateStats();
        }

        function filterCards(filter, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.querySelectorAll('.image-card').forEach(card => {
                let show = true;
                const cardId = card.getAttribute('data-id');
                const chapter = card.getAttribute('data-chapter');
                const type = card.getAttribute('data-type');

                switch(filter) {
                    case 'pending': show = !uploadedImages[cardId]; break;
                    case 'done': show = !!uploadedImages[cardId]; break;
                    case 'cover': show = chapter.includes('cover') || chapter.includes('spine') || chapter.includes('back'); break;
                    case 'diagram': show = type.includes('diagram') || type.includes('grid') || type.includes('comparison'); break;
                }
                card.style.display = show ? 'block' : 'none';
            });
        }

        function exportCSV() {
            let csv = 'id,chapter,image_type,filename,prompt,status\n';
            imageData.forEach(img => {
                const status = uploadedImages[img.id] ? 'uploaded' : 'pending';
                const escapedPrompt = '"' + img.prompt.replace(/"/g, '""') + '"';
                csv += img.id + ',' + img.chapter + ',' + img.type + ',' + img.filename + ',' + escapedPrompt + ',' + status + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = createElement('a', { href: URL.createObjectURL(blob), download: 'image_prompts_updated.csv' });
            a.click();
        }

        init();
    </script>
</body>
</html>
